---
title: "Analysis of flow cytometry data from TN10 participants"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries, mask functions, set theme and directory

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(readxl)
library(stringr)
library(ggrepel)
library(survival)
library(survminer)
library(purrr)
library(lme4)

options(stringsAsFactors = FALSE)
set.seed(42)

`%notin%` <- Negate(`%in%`)
select <- dplyr::select
rename <- dplyr::rename
filter <- dplyr::filter
distinct <- dplyr::distinct
mutate <- dplyr::mutate

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

setwd("/Users/tybottorff/git/Bottorff_CD127_2026/FLOW_CYTOMETRY/")

```

# Read in flow data

```{r}

metadata <- read_xlsx("./raw_data/t1d_metadata.xlsx")
tex_subsets <- read_xlsx("./raw_data/tex_subsets.xlsx") %>%
  mutate(Barcode = str_extract(`Sample:`, "^TN\\d+F\\d+"),
        # use 2 cols to define PD1+ (% Tex)
        PD1_Tex = `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Parent` *
                    `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57- | Freq. of Parent`) %>%
  left_join(metadata, by = "Barcode") %>%
  dplyr::rename(Treatment_Arm = `Treatment Arm of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`,
                Time.to.Disease = `Time.to.T1D (months)`)

```

# Create visit-specific data frames

```{r}

# Freq. of Parent means % within/of direct parent, and Freq. of Total means % total CD8
km_df_3_months <- tex_subsets %>%
  select(Barcode, `Masked ID of Xtrial TN10 treatment info`, `Treatment_Arm`, `Time.to.Disease`, T1D.event, Visit,
         `Q2: TIGIT+ , KLRG1+ | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Total`) %>%
  rename(treatment = `Treatment_Arm`,
         time_to_t1d = `Time.to.Disease`, id = `Masked ID of Xtrial TN10 treatment info`) %>%
  filter(Visit == "3 months")
km_df_baseline <- tex_subsets %>%
  select(Barcode, `Masked ID of Xtrial TN10 treatment info`, `Treatment_Arm`, `Time.to.Disease`, T1D.event, Visit,
         `Q2: TIGIT+ , KLRG1+ | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Total`) %>%
  rename(treatment = `Treatment_Arm`,
         time_to_t1d = `Time.to.Disease`, id = `Masked ID of Xtrial TN10 treatment info`) %>%
  filter(Visit == "Baseline")

```

# Stratify participants by 3-month frequencies of Tex (gated) to compare T1D-free intervals (figure 1A)

```{r}

three_month_tex_df <- km_df_3_months %>%
  mutate(
    strata = case_when(
      treatment == "Placebo" ~ "Placebo",
      treatment == "Teplizumab" & `Q2: TIGIT+ , KLRG1+ | Freq. of Total`
        >= quantile(`Q2: TIGIT+ , KLRG1+ | Freq. of Total`
                    [treatment == "Teplizumab"], probs = 2/3, na.rm = TRUE) ~ "Top1/3",
      treatment == "Teplizumab" ~ "Bottom2/3"
    )
  )
surv_obj <- survfit(Surv(time_to_t1d, T1D.event) ~ strata, data = three_month_tex_df)
fig1A <- ggsurvplot(
  fit = surv_obj,
  data = three_month_tex_df,
  palette = c("#FF0000", "grey", "#FF0001"),
  linetype = c("dotted", "solid", "solid"),
  risk.table = TRUE,
  xlab = "Months",
  ylab = "% T1D Free",
  ylim = c(0, 100),
  fun = function(x) x * 100,
  break.time.by = 12,
  risk.table.height = 0.35,
  surv.plot.height  = 0.65,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
fig1A
pdf("./figures/fig1A.pdf", width = 4, height = 5)
print(fig1A)
dev.off()
# stats
surv_obj <- survfit(Surv(time_to_t1d, T1D.event) ~ strata, data = three_month_tex_df)
# log-rank test: Placebo vs Top1/3
p_top <- {
  df <- three_month_tex_df %>% filter(strata %in% c("Placebo", "Top1/3"))
  surv_diff <- survdiff(Surv(time_to_t1d, T1D.event) ~ strata, data = df)
  pchisq(surv_diff$chisq, df = length(surv_diff$n) - 1, lower.tail = FALSE)
}
# log-rank test: Placebo vs Bottom2/3
p_bot <- {
  df <- three_month_tex_df %>% filter(strata %in% c("Placebo", "Bottom2/3"))
  surv_diff <- survdiff(Surv(time_to_t1d, T1D.event) ~ strata, data = df)
  pchisq(surv_diff$chisq, df = length(surv_diff$n) - 1, lower.tail = FALSE)
}
pvals <- tibble(
  comparison = c("Placebo vs Top1/3", "Placebo vs Bottom2/3"),
  logrank_p = c(p_top, p_bot)
)
pvals

```

# Read in flow clustering data

```{r}

eight_clusters <- read_xlsx("./raw_data/flow_clustering.xlsx") %>%
  # assign cluster numbers
  rename(metacluster_5 = metacluster_1,
         metacluster_1 = metacluster_2,
         metacluster_8 = metacluster_3,
         metacluster_7 = metacluster_4,
         metacluster_6 = metacluster_5,
         metacluster_2 = metacluster_6,
         metacluster_3 = metacluster_7,
         metacluster_4 = metacluster_8) %>%
  rowwise() %>%
  # create a mean of Tex clusters 1-4
  mutate(metacluster_1_2_3_4 = mean(c_across(c(metacluster_1, metacluster_2, metacluster_3, metacluster_4)), na.rm = TRUE)) %>%
  ungroup()

```

# Stratify participants by 3-month frequencies of each cluster separately to compare T1D-free intervals (supplementary figure 2A)

```{r}

marker_cols <- c(
  "metacluster_1",
  "metacluster_2",
  "metacluster_3",
  "metacluster_4",
  "metacluster_5",
  "metacluster_6",
  "metacluster_7",
  "metacluster_8"
)
visit_keep <- "3 months"
top_n      <- 11
cols = c("#302583", "#302584", "#37773C", "#37773D", "#D9CB82", "#D9CB81", "#BF6E7B", "#BF6E7A", "#95CAE8", "#95CAE9", "#61A898", "#61A899", "#9E4C94", "#9E4C95", "#7D2B53", "#7D2B54")
run_one <- function(marker_col, cluster_idx){
  df_base <- eight_clusters %>%
    filter(Visit == visit_keep,
           !is.na(Treatment_Arm),
           !is.na(.data[[marker_col]]))
  tez <- df_base %>% filter(Treatment_Arm == "Teplizumab")
  top_idx <- order(tez[[marker_col]], decreasing = TRUE)[seq_len(min(top_n, nrow(tez)))]
  tez$group <- "Tep lo"
  tez$group[top_idx] <- "Tep hi"
  df_base$group <- NA_character_
  df_base$group[df_base$Treatment_Arm == "Placebo"]    <- "Placebo"
  df_base$group[df_base$Treatment_Arm == "Teplizumab"] <- tez$group
  df_base$group <- factor(df_base$group,
                          levels = c("Tep hi","Tep lo","Placebo"))
  fit <- survfit(Surv(Time.to.Disease, T1D.event) ~ group, data = df_base)
  current_hi_col <- cols[(cluster_idx-1)*2 + 1]
  current_lo_col <- cols[(cluster_idx-1)*2 + 2]
  p <- ggsurvplot(
    fit,
    data = df_base,
    risk.table = TRUE,
    break.time.by = 12,
    xlim = c(0, 86),
    xlab = "Months",
    ylab = "% T1D free",
    palette = c(current_hi_col, current_lo_col, "grey"),
    linetype = c("solid", "dotted", "solid"),
    fun = function(x) x * 100,
    risk.table.height = 0.45,
    surv.plot.height  = 0.55,
    risk.table.fontsize = 5,
    tables.theme = theme(
      panel.background = element_blank(),
      panel.grid = element_blank(),
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
  )
  pdf(file = paste0("./figures/", "supp_fig_2A_", marker_col), width = 3, height = 5)
  print(p)
  dev.off()
  # stats
  sdiff <- pairwise_survdiff(
    Surv(Time.to.Disease, T1D.event) ~ group,
    data = df_base,
    p.adjust.method = "none"
  )
  list(
    marker = marker_col,
    pairwise = sdiff,
    top_vs_placebo =
      survdiff(Surv(Time.to.Disease, T1D.event) ~
                 factor(group %in% c("Tep hi","Placebo"),
                        levels = c(FALSE, TRUE)),
               data = df_base),
    bot23_vs_placebo =
      survdiff(Surv(Time.to.Disease, T1D.event) ~
                 factor(group %in% c("Tep lo","Placebo"),
                        levels = c(FALSE, TRUE)),
               data = df_base)
  )
}
results_list <- map2(marker_cols, seq_along(marker_cols), run_one)

```

# Stratify participants by 3-month frequencies of clusters 1-4 combined (Tex) to compare T1D-free intervals (figure 1C)

```{r}

marker_col <- "metacluster_1_2_3_4"
visit_keep <- "3 months"
top_n <- 11
df_base <- eight_clusters %>%
  filter(Visit == visit_keep & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_col]]))
tez <- df_base %>% filter(Treatment_Arm == "Teplizumab")
top_idx <- order(tez[[marker_col]], decreasing = TRUE)[seq_len(min(top_n, nrow(tez)))]
tez$group <- "Tep lo"
tez$group[top_idx] <- "Tep hi"
df_base$group <- NA_character_
df_base$group[df_base$Treatment_Arm == "Placebo"] <- "Placebo"
df_base$group[df_base$Treatment_Arm == "Teplizumab"] <- tez$group
df_base$group <- factor(df_base$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_obj <- Surv(time = df_base$Time.to.Disease, event = df_base$T1D.event)
fit <- survfit(surv_obj ~ group, data = df_base)
fig1C <- ggsurvplot(
  fit,
  data = df_base,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#000000", "#000001", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
fig1C
pdf("./figures/fig1C.pdf", width = 3, height = 5)
print(fig1C)
dev.off()
pairwise_pvals <- pairwise_survdiff(
  Surv(Time.to.Disease, T1D.event) ~ group,
  data = df_base,
  p.adjust.method = "none"
)
pairwise_pvals

```

# Stratify participants by baseline frequencies of clusters 8 (SKIM) to compare T1D-free intervals (figure 1D, left panel)

```{r}

marker_col <- "metacluster_8"
visit_keep <- "Baseline"
top_n <- 11
df_base <- eight_clusters %>%
  filter(Visit == visit_keep & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_col]]))
tez <- df_base %>% filter(Treatment_Arm == "Teplizumab")
top_idx <- order(tez[[marker_col]], decreasing = TRUE)[seq_len(min(top_n, nrow(tez)))]
tez$group <- "Tep lo"
tez$group[top_idx] <- "Tep hi"
df_base$group <- NA_character_
df_base$group[df_base$Treatment_Arm == "Placebo"] <- "Placebo"
df_base$group[df_base$Treatment_Arm == "Teplizumab"] <- tez$group
df_base$group <- factor(df_base$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_obj <- Surv(time = df_base$Time.to.Disease, event = df_base$T1D.event)
fit <- survfit(surv_obj ~ group, data = df_base)
fig1D_left <- ggsurvplot(
  fit,
  data = df_base,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#7D2B54", "#7D2B55", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
fig1D_left
pdf("./figures/fig1D_left.pdf", width = 3, height = 5)
print(fig1D_left)
dev.off()
pairwise_pvals <- pairwise_survdiff(
  Surv(Time.to.Disease, T1D.event) ~ group,
  data = df_base,
  p.adjust.method = "none"
)
pairwise_pvals

```

# Stratify participants by 3-month frequencies of clusters 8 (SKIM) to compare T1D-free intervals (figure 1D, right)

```{r}

marker_col <- "metacluster_8"
visit_keep <- "3 months"
top_n <- 11
df_base <- eight_clusters %>%
  filter(Visit == visit_keep & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_col]]))
tez <- df_base %>% filter(Treatment_Arm == "Teplizumab")
top_idx <- order(tez[[marker_col]], decreasing = TRUE)[seq_len(min(top_n, nrow(tez)))]
tez$group <- "Tep lo"
tez$group[top_idx] <- "Tep hi"
df_base$group <- NA_character_
df_base$group[df_base$Treatment_Arm == "Placebo"] <- "Placebo"
df_base$group[df_base$Treatment_Arm == "Teplizumab"] <- tez$group
df_base$group <- factor(df_base$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_obj <- Surv(time = df_base$Time.to.Disease, event = df_base$T1D.event)
fit <- survfit(surv_obj ~ group, data = df_base)
fig1D_right <- ggsurvplot(
  fit,
  data = df_base,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#7D2B54", "#7D2B55", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
fig1D_right
pdf("./figures/fig1D_right.pdf", width = 3, height = 5)
print(fig1D_right)
dev.off()
pairwise_pvals <- pairwise_survdiff(
  Surv(Time.to.Disease, T1D.event) ~ group,
  data = df_base,
  p.adjust.method = "none"
)
pairwise_pvals

```

# Plot frequencies of SKIM (cluster 8) and Tex (clusters 1-4 combined) over time (figure 1E)

```{r}

visit_map <- c("Baseline" = 0, "3 months" = 3, "6 months" = 6, "18 months" = 18)
facet_labels <- c(
  "metacluster_8" = "Cluster 8 (SKIM)",
  "metacluster_1_2_3_4" = "Clusters 1-4 (TEX)"
)
df_long <- eight_clusters %>%
  select(Visit, Treatment_Arm, `Masked ID of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`, metacluster_8, metacluster_1_2_3_4) %>%
  filter(!is.na(Visit)) %>%
  mutate(
    Visit_num = recode(Visit, !!!visit_map) %>% as.numeric(),
    Visit = factor(Visit, levels = names(visit_map))
  ) %>%
  pivot_longer(
    cols = c(metacluster_8, metacluster_1_2_3_4),
    names_to = "metacluster_group",
    values_to = "frequency"
  ) %>%
  mutate(frequency = frequency*100,
         Treatment_Arm = case_when(
           Treatment_Arm == "Placebo" ~ "Placebo (n = 25)",
           Treatment_Arm == "Teplizumab" ~ "Teplizumab (n = 35)"),
         metacluster_group = factor(metacluster_group, levels = c("metacluster_8", "metacluster_1_2_3_4"))) %>%
  filter(Visit %in% c("Baseline", "3 months"))
baseline_df <- df_long %>%
  filter(Visit == "Baseline") %>%
  select(`Masked ID of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`, metacluster_group, baseline_frequency = frequency)
df_long <- df_long %>%
  left_join(baseline_df, by = c("Masked ID of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file", "metacluster_group")) %>%
  mutate(
    percent_change = 100 * (frequency - baseline_frequency) / baseline_frequency
  )
summary_df <- df_long %>%
  group_by(Visit_num, Treatment_Arm, metacluster_group) %>%
  summarise(
    mean_freq = mean(percent_change, na.rm = TRUE),
    sem = sd(percent_change, na.rm = TRUE) / sqrt(sum(!is.na(percent_change))),
    .groups = "drop"
  ) %>%
  mutate(
    Treatment_cluster = case_when(
      Treatment_Arm == "Placebo (n = 25)" ~ "Placebo",
      Treatment_Arm == "Teplizumab (n = 35)" & metacluster_group == "metacluster_8" ~ "Tep_cluster8",
      Treatment_Arm == "Teplizumab (n = 35)" & metacluster_group == "metacluster_1_2_3_4" ~ "Tep_cluster1_4"
    )
  )
fig1E <- ggplot() +
  geom_line(
    data = summary_df,
    aes(x = Visit_num, y = mean_freq, group = Treatment_cluster, color = Treatment_cluster),
    linewidth = 1.5
  ) +
  # Error bars (mean Â± SEM)
  geom_errorbar(
    data = summary_df,
    aes(x = Visit_num, ymin = mean_freq - sem, ymax = mean_freq + sem, color = Treatment_cluster),
    width = 0.4, linewidth = 0.8
  ) +
  facet_wrap(~metacluster_group, labeller = labeller(metacluster_group = facet_labels)) +
  labs(
    x = "Months",
    y = "change in frequency\nfrom baseline (%)",
    color = ""
  ) +
  theme(legend.text = element_text(size = 12),
        legend.position = "bottom") +
  scale_color_manual(
  values = c(
    "Placebo"        = "grey60",
    "Tep_cluster8"   = "#7D2B54",
    "Tep_cluster1_4" = "black"
  ))
fig1E
cluster8_df <- df_long %>%
  filter(metacluster_group == "metacluster_8",
         Visit %in% c("Baseline", "3 months"))
model_cluster8 <- lmer(
  percent_change ~ Visit_num * Treatment_Arm + (1 | `Masked ID of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`),
  data = cluster8_df
)
summary(model_cluster8)
cluster1_4_df <- df_long %>%
  filter(metacluster_group == "metacluster_1_2_3_4",
         Visit %in% c("Baseline", "3 months"))
model_cluster1_4 <- lmer(
  percent_change ~ Visit_num * Treatment_Arm + (1 | `Masked ID of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`),
  data = cluster1_4_df
)
summary(model_cluster1_4)
ggsave("./figures/fig1E.pdf", width = 6, height = 4)

```

# Stratify both teplizumab and placebo participants by baseline frequencies of clusters 8 (SKIM) to compare T1D-free intervals (figure 3A)

```{r}

marker_col <- "metacluster_8"
visit_keep <- "Baseline"
top_n <- 11
df_base <- eight_clusters %>%
  filter(Visit == visit_keep & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_col]]))
tez <- df_base %>% filter(Treatment_Arm == "Teplizumab")
plac <- df_base %>% filter(Treatment_Arm == "Placebo")
tez$group <- "Tep lo"
tez$group[order(tez[[marker_col]], decreasing = TRUE)[seq_len(min(top_n, nrow(tez)))]] <- "Tep hi"
plac$group <- "Pbo lo"
plac$group[order(plac[[marker_col]], decreasing = TRUE)[seq_len(min(8, nrow(plac)))]] <- "Pbo hi"
df_base <- bind_rows(tez, plac)
df_base$group <- factor(df_base$group, levels = c("Tep hi", "Tep lo", "Pbo hi", "Pbo lo"))
surv_obj <- Surv(time = df_base$Time.to.Disease, event = df_base$T1D.event)
fit <- survfit(surv_obj ~ group, data = df_base)
fig3A <- ggsurvplot(
  fit,
  data = df_base,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#7D2B54", "#7D2B55", "#bebebe", "#bebebf"),
  linetype = c("solid", "dotted", "solid", "dotted"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
fig3A
pdf("./figures/fig3A.pdf", width = 3, height = 5)
print(fig3A)
dev.off()
pairwise_pvals <- pairwise_survdiff(
  Surv(Time.to.Disease, T1D.event) ~ group,
  data = df_base,
  p.adjust.method = "none"
)
pairwise_pvals

```

# Stratify participants by 3-month frequencies of CD127+ (% Tex) to compare T1D-free intervals (figure 4B)

```{r}

marker_cd127 <- "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent"
df_cd127 <- tex_subsets %>%
  filter(Visit == "3 months" & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_cd127]]))
tez_cd127 <- df_cd127 %>% filter(Treatment_Arm == "Teplizumab")
top_cd127_idx <- order(tez_cd127[[marker_cd127]], decreasing = TRUE)[1:11]
tez_cd127$group <- "Tep lo"
tez_cd127$group[top_cd127_idx] <- "Tep hi"
df_cd127$group <- NA_character_
df_cd127$group[df_cd127$Treatment_Arm == "Placebo"] <- "Placebo"
df_cd127$group[df_cd127$Treatment_Arm == "Teplizumab"] <- tez_cd127$group
df_cd127$group <- factor(df_cd127$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_cd127 <- Surv(df_cd127$Time.to.Disease, df_cd127$T1D.event)
fit_cd127 <- survfit(surv_cd127 ~ group, data = df_cd127)
fig_4B <- ggsurvplot(
  fit_cd127,
  data = df_cd127,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#BF6E7A", "#BF6E7B", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
fig_4B
pairwise_survdiff(Surv(Time.to.Disease, T1D.event) ~ group, data = df_cd127, p.adjust.method = "none")
pdf("./figures/fig_4B.pdf", width = 3, height = 5)
print(fig_4B) 
dev.off()

```

# Stratify both teplizumab and placebo participants by 3-month frequencies of CD127+ (% Tex) to compare T1D-free intervals (supplementary figure 6B)

```{r}

df_cd127 <- tex_subsets %>%
  filter(Visit == "3 months" & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_cd127]]))
tez_cd127 <- df_cd127 %>% filter(Treatment_Arm == "Teplizumab")
plac_cd127 <- df_cd127 %>% filter(Treatment_Arm == "Placebo")
top_cd127_idx_tez <- order(tez_cd127[[marker_cd127]], decreasing = TRUE)[1:11]
top_cd127_idx_plac <- order(plac_cd127[[marker_cd127]], decreasing = TRUE)[1:7]
tez_cd127$group <- "Tep lo"
tez_cd127$group[top_cd127_idx_tez] <- "Tep hi"
plac_cd127$group <- "Pbo lo"
plac_cd127$group[top_cd127_idx_plac] <- "Pbo hi"
df_cd127$group <- NA_character_
df_cd127$group[df_cd127$Treatment_Arm == "Placebo"] <- plac_cd127$group
df_cd127$group[df_cd127$Treatment_Arm == "Teplizumab"] <- tez_cd127$group
df_cd127$group <- factor(df_cd127$group, levels = c("Tep hi", "Tep lo", "Pbo hi", "Pbo lo"))
surv_cd127 <- Surv(df_cd127$Time.to.Disease, df_cd127$T1D.event)
fit_cd127 <- survfit(surv_cd127 ~ group, data = df_cd127)
supp_fig_6B <- ggsurvplot(
  fit_cd127,
  data = df_cd127,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#BF6E7A", "#BF6E7B", "#bebebf", "#bebebe"),
  linetype = c("solid", "dotted", "solid", "dotted"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24)))
supp_fig_6B
pairwise_survdiff(Surv(Time.to.Disease, T1D.event) ~ group, data = df_cd127, p.adjust.method = "none")
pdf("./figures/supp_fig_6B.pdf", width = 3, height = 5)
print(supp_fig_6B)
dev.off()

```

# Stratify participants by 3-month frequencies of CD57+ (% Tex) to compare T1D-free intervals (figure 4C)

```{r}

marker_cd57 <- "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Parent"
df_cd57 <- tex_subsets %>%
  filter(Visit == "3 months" & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_cd57]]))
tez_cd57 <- df_cd57 %>% filter(Treatment_Arm == "Teplizumab")
top_cd57_idx <- order(tez_cd57[[marker_cd57]], decreasing = TRUE)[1:11]
tez_cd57$group <- "Tep lo"
tez_cd57$group[top_cd57_idx] <- "Tep hi"
df_cd57$group <- NA_character_
df_cd57$group[df_cd57$Treatment_Arm == "Placebo"] <- "Placebo"
df_cd57$group[df_cd57$Treatment_Arm == "Teplizumab"] <- tez_cd57$group
df_cd57$group <- factor(df_cd57$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_cd57 <- Surv(df_cd57$Time.to.Disease, df_cd57$T1D.event)
fit_cd57 <- survfit(surv_cd57 ~ group, data = df_cd57)
fig_4C <- ggsurvplot(
  fit_cd57,
  data = df_cd57,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#302583", "#302584", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
fig_4C
pairwise_survdiff(Surv(Time.to.Disease, T1D.event) ~ group, data = df_cd57, p.adjust.method = "none")
pdf("./figures/fig_4C.pdf", width = 3, height = 5)
print(fig_4C)
dev.off()

```

# Stratify participants by 3-month frequencies of PD1+ (% Tex) to compare T1D-free intervals (figure 4D)

```{r}

df_pd1 <- tex_subsets %>%
  filter(Visit == "3 months" & !is.na(Treatment_Arm)) %>%
  filter(!is.na(PD1_Tex))
tez_pd1 <- df_pd1 %>% filter(Treatment_Arm == "Teplizumab")
top_pd1_idx <- order(tez_pd1$PD1_Tex, decreasing = TRUE)[1:11]
tez_pd1$group <- "Tep lo"
tez_pd1$group[top_pd1_idx] <- "Tep hi"
df_pd1$group <- NA_character_
df_pd1$group[df_pd1$Treatment_Arm == "Placebo"] <- "Placebo"
df_pd1$group[df_pd1$Treatment_Arm == "Teplizumab"] <- tez_pd1$group
df_pd1$group <- factor(df_pd1$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_pd1 <- Surv(df_pd1$Time.to.Disease, df_pd1$T1D.event)
fit_pd1 <- survfit(surv_pd1 ~ group, data = df_pd1)
fig_4D <- ggsurvplot(
  fit_pd1,
  data = df_pd1,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#37773C", "#37773D", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
fig_4D
pairwise_survdiff(Surv(Time.to.Disease, T1D.event) ~ group, data = df_pd1, p.adjust.method = "none")
pdf("./figures/fig_4D.pdf", width = 3, height = 5)
print(fig_4D)
dev.off()

```

# Stratify participants by baseline frequencies of CD127+ (% Tex) to compare T1D-free intervals (supplementary figure 6C)

```{r}

marker_cd127 <- "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent"
df_cd127 <- tex_subsets %>%
  filter(Visit == "Baseline" & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_cd127]]))
tez_cd127 <- df_cd127 %>% filter(Treatment_Arm == "Teplizumab")
top_cd127_idx <- order(tez_cd127[[marker_cd127]], decreasing = TRUE)[1:11]
tez_cd127$group <- "Tep lo"
tez_cd127$group[top_cd127_idx] <- "Tep hi"
df_cd127$group <- NA_character_
df_cd127$group[df_cd127$Treatment_Arm == "Placebo"] <- "Placebo"
df_cd127$group[df_cd127$Treatment_Arm == "Teplizumab"] <- tez_cd127$group
df_cd127$group <- factor(df_cd127$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_cd127 <- Surv(df_cd127$Time.to.Disease, df_cd127$T1D.event)
fit_cd127 <- survfit(surv_cd127 ~ group, data = df_cd127)
supp_fig_6C <- ggsurvplot(
  fit_cd127,
  data = df_cd127,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#BF6E7A", "#BF6E7B", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
supp_fig_6C
pairwise_survdiff(Surv(Time.to.Disease, T1D.event) ~ group, data = df_cd127, p.adjust.method = "none")
pdf("./figures/supp_fig_6C.pdf", width = 3, height = 5)
print(supp_fig_6C)
dev.off()

```

# Stratify participants by baseline frequencies of CD57+ (% Tex) to compare T1D-free intervals (supplementary figure 6D)

```{r}

marker_cd57 <- "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Parent"
df_cd57 <- tex_subsets %>%
  filter(Visit == "Baseline" & !is.na(Treatment_Arm)) %>%
  filter(!is.na(.data[[marker_cd57]]))
tez_cd57 <- df_cd57 %>% filter(Treatment_Arm == "Teplizumab")
top_cd57_idx <- order(tez_cd57[[marker_cd57]], decreasing = TRUE)[1:11]
tez_cd57$group <- "Tep lo"
tez_cd57$group[top_cd57_idx] <- "Tep hi"
df_cd57$group <- NA_character_
df_cd57$group[df_cd57$Treatment_Arm == "Placebo"] <- "Placebo"
df_cd57$group[df_cd57$Treatment_Arm == "Teplizumab"] <- tez_cd57$group
df_cd57$group <- factor(df_cd57$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_cd57 <- Surv(df_cd57$Time.to.Disease, df_cd57$T1D.event)
fit_cd57 <- survfit(surv_cd57 ~ group, data = df_cd57)
supp_fig_6D <- ggsurvplot(
  fit_cd57,
  data = df_cd57,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#302583", "#302584", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
supp_fig_6D
pairwise_survdiff(Surv(Time.to.Disease, T1D.event) ~ group, data = df_cd57, p.adjust.method = "none")
pdf("./figures/supp_fig_6D.pdf", width = 3, height = 5)
print(supp_fig_6D)
dev.off()

```

# Stratify participants by baseline frequencies of PD1+ (% Tex) to compare T1D-free intervals (supplementary figure 6E)

```{r}

df_pd1 <- tex_subsets %>%
  filter(Visit == "Baseline" & !is.na(Treatment_Arm)) %>%
  filter(!is.na(PD1_Tex))
tez_pd1 <- df_pd1 %>% filter(Treatment_Arm == "Teplizumab")
top_pd1_idx <- order(tez_pd1$PD1_Tex, decreasing = TRUE)[1:11]
tez_pd1$group <- "Tep lo"
tez_pd1$group[top_pd1_idx] <- "Tep hi"
df_pd1$group <- NA_character_
df_pd1$group[df_pd1$Treatment_Arm == "Placebo"] <- "Placebo"
df_pd1$group[df_pd1$Treatment_Arm == "Teplizumab"] <- tez_pd1$group
df_pd1$group <- factor(df_pd1$group, levels = c("Tep hi", "Tep lo", "Placebo"))
surv_pd1 <- Surv(df_pd1$Time.to.Disease, df_pd1$T1D.event)
fit_pd1 <- survfit(surv_pd1 ~ group, data = df_pd1)
supp_fig_6E <- ggsurvplot(
  fit_pd1,
  data = df_pd1,
  risk.table = TRUE,
  break.time.by = 12,
  xlim = c(0, 86),
  xlab = "Months",
  ylab = "% T1D free",
  palette = c("#37773C", "#37773D", "grey"),
  linetype = c("solid", "dotted", "solid"),
  fun = function(x) x * 100,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
supp_fig_6E
pairwise_survdiff(Surv(Time.to.Disease, T1D.event) ~ group, data = df_pd1, p.adjust.method = "none")
pdf("./figures/supp_fig_6E.pdf", width = 3, height = 5)
print(supp_fig_6E)
dev.off()

```

# Investigate association between SKIM and changes in Tex

```{r}

km_df_baseline_skim_scatter <- tex_subsets %>%
  dplyr::select(Barcode, `Masked ID of Xtrial TN10 treatment info`, Treatment_Arm, Time.to.Disease, T1D.event, Visit,
         `Q2: TIGIT+ , KLRG1+ | Freq. of Total`,
         `Q2: TIGIT+ , KLRG1+ | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q1: TIGIT- , KLRG1+/CD127+ | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q1: TIGIT- , KLRG1+/CD127+ | Freq. of Total`) %>%
  dplyr::rename(treatment = Treatment_Arm,
         time_to_t1d = Time.to.Disease, id = `Masked ID of Xtrial TN10 treatment info`) %>%
  filter(Visit %in% c("Baseline", "3 months")) %>%
  group_by(id) %>%
  filter(n() == 2) %>%
  # get changes in Tex from 0 to 3 months
  mutate(delta_dp = `Q2: TIGIT+ , KLRG1+ | Freq. of Parent`[Visit == "3 months"] - `Q2: TIGIT+ , KLRG1+ | Freq. of Parent`[Visit == "Baseline"],
         delta_dp_cd57 = `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Parent`[Visit == "3 months"] - `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Parent`[Visit == "Baseline"],
         delta_dp_pd1 = `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Parent`[Visit == "3 months"] - `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Parent`[Visit == "Baseline"],
         delta_dp_cd127 = `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent`[Visit == "3 months"] - `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent`[Visit == "Baseline"]) %>%
  filter(Visit == "Baseline",
         treatment == "Teplizumab") %>%
  ungroup()

```

# Create idealized extreme models of (in)dependence between SKIM and CD127+ Tex frequencies (figure 5A)

```{r}

dummy_df <- read_xlsx("./raw_data/dummy_data_fig5_models.xlsx") %>%
  filter(model == "model 1" | model == "model 2" & (baseline_skim > CD127_tex_three_months*2 | baseline_skim < CD127_tex_three_months*2)) %>%
  group_by(model) %>%
  mutate(skim_tert = ntile(baseline_skim, 3),
         skim_tert = case_when(
           skim_tert %in% c(1, 2) ~ "SKIM lo",
           skim_tert == 3 ~ "SKIM hi"),
         cd127_tex_tert = ntile(CD127_tex_three_months, 3),
           cd127_tex_tert = case_when(
           cd127_tex_tert %in% c(1, 2) ~ "CD127 Tex lo",
           cd127_tex_tert == 3 ~ "CD127 Tex hi"))
cuts_df <- dummy_df %>%
  group_by(model) %>%
  summarise(
    skim_cuts = list(quantile(baseline_skim, probs = c(1/3, 2/3), na.rm = TRUE)),
    cd127_cuts = list(quantile(CD127_tex_three_months, probs = c(1/3, 2/3), na.rm = TRUE))
  )
fig5A <- ggplot(dummy_df,
       aes(x = baseline_skim, y = CD127_tex_three_months))+
  geom_point(size = 2) +
  facet_wrap(~ model, scales = "free_y") +
  ylim(0, 100) +
  xlim(0, 100) +
  labs(
    x = "SKIM frequency",
    y = "CD127+ Tex\nfrequency") +
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank()) +
  geom_vline(data = cuts_df,
             aes(xintercept = skim_cuts[[1]][2]),
             linetype = "dotted") +
  geom_hline(data = cuts_df,
             aes(yintercept = cd127_cuts[[1]][2]),
             linetype = "dotted") +
  theme(
    strip.background = element_rect(fill = "white", color = "black"),
    strip.text = element_text(color = "black")
  )
fig5A
ggsave("./figures/fig5A.pdf", fig5A, width = 5.5, height = 3)

```

# Compare baseline SKIM & 3-month CD127+ Tex frequencies (figure 5B)

```{r}

scatter_df <- tex_subsets %>%
  select(
    Barcode,
    id = `Masked ID of Xtrial TN10 treatment info`,
    treatment = Treatment_Arm,
    time_to_t1d = Time.to.Disease,
    T1D.event,
    Visit,
   `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent`,
    `CD45RA, CCR7 subset-/Q1: TIGIT- , KLRG1+/CD127+ | Freq. of Total`
  ) %>%
  filter(treatment == "Teplizumab") %>%
  pivot_longer(
    cols = starts_with("CD45RA"),
    names_to = "marker",
    values_to = "marker_value"
  ) %>%
  filter(
    (Visit == "Baseline" &
       marker %in% c(
         # SKIM (% CD8)
         "CD45RA, CCR7 subset-/Q1: TIGIT- , KLRG1+/CD127+ | Freq. of Total"
       )) |
      (Visit == "3 months" &
         marker %in% c(
           # CD127+ (% Tex)
           "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent"
         ))
  ) %>%
  mutate(
    marker_clean = case_when(
      Visit == "Baseline"  ~ "baseline_skim",
      Visit == "3 months" ~ "cd127_tex_3mo"
    )
  ) %>%
  group_by(id, treatment, time_to_t1d, T1D.event, marker_clean) %>%
  summarise(value = dplyr::first(marker_value), .groups = "drop") %>%
  pivot_wider(
    names_from = marker_clean,
    values_from = value
  ) %>%
  mutate(
    x_group = if_else(
      baseline_skim >= quantile(baseline_skim, 2/3, na.rm = TRUE),
      "SKIM hi",
      "SKIM lo"
    ),
    y_group = if_else(
      cd127_tex_3mo >= quantile(cd127_tex_3mo, 2/3, na.rm = TRUE),
      "CD127+ Tex hi",
      "CD127+ Tex lo"
    )
  ) %>%
  filter(!(is.na(cd127_tex_3mo)), !(is.na(baseline_skim)))
x_cut <- quantile(scatter_df$baseline_skim, 2/3, na.rm = TRUE)
y_cut <- quantile(scatter_df$cd127_tex_3mo, 2/3, na.rm = TRUE)
fit <- lm(cd127_tex_3mo ~ baseline_skim, data = scatter_df)
pval <- summary(fit)$coefficients["baseline_skim", "Pr(>|t|)"]
pval_text <- paste0("p = ", signif(pval, 3))
fig_5B <- ggplot(scatter_df,
            aes(x = baseline_skim,
                y = cd127_tex_3mo)) +
  geom_point(size = 2) +
  geom_abline(
    intercept = coef(fit)[1],
    slope = coef(fit)[2],
    linewidth = 1
  ) +
  geom_vline(xintercept = x_cut, linetype = "dashed") +
  geom_hline(yintercept = y_cut, linetype = "dashed") +
  labs(
    x = "Baseline SKIM\n(% CD8)",
    y = "3-month CD127+\n(% Tex)"
  )
fig_5B
ggsave("./figures/fig_5B.pdf", fig_5B, width = 3.5, height = 3.3)
three_month_tex <- scatter_df %>%
  rename(cd127_tex_value = cd127_tex_3mo) %>%
  mutate(cd127_tex_time = "3 months CD127+ Tex")
obs_concordant <- sum(
    (scatter_df$x_group == "SKIM hi" & scatter_df$y_group == "CD127+ Tex hi") |
        (scatter_df$x_group == "SKIM lo" & scatter_df$y_group == "CD127+ Tex lo")
)
perm <- replicate(1e5, {
    y_perm <- sample(scatter_df$cd127_tex_3mo)
    x_group_perm <- ifelse(scatter_df$baseline_skim >= x_cut, "SKIM hi", "SKIM lo")
    y_group_perm <- ifelse(y_perm >= y_cut, "CD127+ Tex hi", "CD127+ Tex lo")
    sum((x_group_perm == "SKIM hi" & y_group_perm == "CD127+ Tex hi") |
            (x_group_perm == "SKIM lo" & y_group_perm == "CD127+ Tex lo"))
})
mean(perm >= obs_concordant)
quad_tab <- table(
  SKIM = scatter_df$x_group,
  CD127_Tex = scatter_df$y_group
)
# Fisher's exact test (enrichment of concordant hi/hi + lo/lo)
fisher_res <- fisher.test(quad_tab)
fisher_res$p.value
# Spearman correlation (continuous values)
spearman_res <- cor.test(
  scatter_df$baseline_skim,
  scatter_df$cd127_tex_3mo,
  method = "spearman",
  exact = FALSE
)
spearman_res$estimate
spearman_res$p.value

```

# Stratify participants by 3-month frequencies of CD127+ (% Tex) to compare Tex frequencies over time (supplementary figure 6F)

```{r}

tex_chrono_df <- tex_subsets %>%
  filter(`Treatment Arm of Xtrial TN10 treatment info` == "Teplizumab") %>%
  dplyr::select(Barcode, `Masked ID of Xtrial TN10 treatment info`, Treatment_Arm, Time.to.Disease, T1D.event, Visit,
         `Q2: TIGIT+ , KLRG1+ | Freq. of Total`,
         `Q2: TIGIT+ , KLRG1+ | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q4: CD127- , CD57-/PD1+ CD8 | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q1: CD127- , CD57+ | Freq. of Total`,
         `CD45RA, CCR7 subset-/Q1: TIGIT- , KLRG1+/CD127+ | Freq. of Parent`,
         `CD45RA, CCR7 subset-/Q1: TIGIT- , KLRG1+/CD127+ | Freq. of Total`) %>%
  dplyr::rename(treatment = Treatment_Arm,
         time_to_t1d = Time.to.Disease, id = `Masked ID of Xtrial TN10 treatment info`)
cd127_tex_terciles <- tex_chrono_df %>%
  filter(Visit == "3 months") %>%
  transmute(
    id,
    baseline_cd127_tex = .data[["CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent"]],
    tertile = ntile(baseline_cd127_tex, 3)
  )
tex_chrono_df_with_cd127_tex_tertiles <- tex_chrono_df %>%
  left_join(cd127_tex_terciles, by = "id")
tex_Parent_cols <- c(
  "Q2: TIGIT+ , KLRG1+ | Freq. of Parent",                                   # Parent Tex
  "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent"            # CD127+ Tex
)
visit_numeric <- c("Baseline" = 0, "3 months" = 3, "6 months" = 6, "18 months" = 18)
plot_df <- tex_chrono_df_with_cd127_tex_tertiles %>%
  select(id, Visit, tertile, all_of(tex_Parent_cols)) %>%
  pivot_longer(
    cols = all_of(tex_Parent_cols),
    names_to = "subset",
    values_to = "value"
  ) %>%
  filter(!(is.na(Visit)),
         !is.na(tertile)) %>%
    mutate(
    tertile = factor(tertile, labels = c("Low", "Mid", "High")),
    subset = case_when(
      subset == "Q2: TIGIT+ , KLRG1+ | Freq. of Parent" ~ "Tex",
      subset == "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent" ~ "CD127+ Tex",
      TRUE ~ subset
    ),
    Visit_num = visit_numeric[Visit]) %>%
  mutate(tertile = as.factor(if_else(tertile %in% c("Mid", "Low"), "CD127+ Tex lo", "CD127+ Tex hi")))
summary_df <- plot_df %>%
  group_by(subset, Visit_num, tertile) %>%
  summarise(
    mean_val = mean(value, na.rm = TRUE),
    se = sd(value, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )
pd <- position_dodge(width = 1)
supp_fig_6F <- ggplot(summary_df %>% filter(subset == "Tex"),
       aes(x = Visit_num, y = mean_val,
           color = tertile,
           group = tertile,
           linetype = tertile)) +
  geom_line(position = pd, size = 1) +
  geom_point(size = 1, position = pd) +
  geom_errorbar(
    aes(ymin = mean_val - se, ymax = mean_val + se),
    width = 0,
    position = pd
  ) +
  scale_linetype_manual(values = c(
    "CD127+ Tex lo" = "dotted",
    "CD127+ Tex hi" = "solid"
  )) +
  scale_color_manual(values = c(
    "CD127+ Tex lo" = "#bf6e7a",
    "CD127+ Tex hi" = "#bf6e7b"
  )) +
  scale_y_continuous(n.breaks = 3) +
  labs(y = "TIGIT+KLRG1+\nfrequency (% CD8)",
      x = "Time (months)",
      linetype = "3-month\nCD127+ Tex\nfrequency") +
  theme(
    axis.title.y = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10)
  )
supp_fig_6F
ggsave("./figures/supp_fig_6F.pdf", supp_fig_6F, width = 4, height = 2)

```

# Stratify participants by baseline SKIM frequencies to compare CD127+ (% Tex) frequencies over time (supplementary figure 6G)

```{r}

skim_terciles <- tex_chrono_df %>%
  filter(Visit == "Baseline") %>%
  transmute(
    id,
    baseline_skim = .data[["CD45RA, CCR7 subset-/Q1: TIGIT- , KLRG1+/CD127+ | Freq. of Total"]],
    tertile = ntile(baseline_skim, 3)
  )
tex_chrono_df_with_skim_tertiles <- tex_chrono_df %>%
  left_join(skim_terciles, by = "id")
tex_Parent_cols <- c(
  "Q2: TIGIT+ , KLRG1+ | Freq. of Parent",                                   # Parent Tex
  "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent"            # CD127+ Tex
)
visit_numeric <- c("Baseline" = 0, "3 months" = 3, "6 months" = 6, "18 months" = 18)
summary_df_2 <- tex_chrono_df_with_skim_tertiles %>%
  dplyr::select(id, Visit, tertile, all_of(tex_Parent_cols)) %>%
  pivot_longer(
    cols = all_of(tex_Parent_cols),
    names_to = "subset",
    values_to = "value"
  ) %>%
  filter(!(is.na(Visit)),
         !is.na(tertile)) %>%
    mutate(
    tertile = factor(tertile, labels = c("Low", "Mid", "High")),
    subset = case_when(
      subset == "Q2: TIGIT+ , KLRG1+ | Freq. of Parent" ~ "Tex",
      subset == "CD45RA, CCR7 subset-/Q2: TIGIT+ , KLRG1+/Q3: CD127+ , CD57- | Freq. of Parent" ~ "CD127+ Tex",
      TRUE ~ subset
    ),
    Visit_num = visit_numeric[Visit]) %>%
  mutate(tertile = as.factor(if_else(tertile %in% c("Mid", "Low"), "SKIM lo", "SKIM hi"))) %>%
  group_by(subset, Visit_num, tertile) %>%
  summarise(
    mean_val = mean(value, na.rm = TRUE),
    se = sd(value, na.rm = TRUE) / sqrt(n()),
    .groups = "drop" ) %>%
  mutate(facet_tertile = paste(subset, tertile, sep = "_")) %>%
  filter(facet_tertile %in% c("CD127+ Tex_SKIM hi", "CD127+ Tex_SKIM lo"))
pd <- position_dodge(width = 1)
supp_fig_6G <- ggplot(summary_df_2,
       aes(x = Visit_num, y = mean_val,
           color = facet_tertile,
           group = facet_tertile,
           linetype = tertile)) +
  geom_line(position = pd, size = 1) +
  geom_point(size = 1, position = pd) +
  geom_errorbar(
    aes(ymin = mean_val - se, ymax = mean_val + se),
    width = 0,
    position = pd
  ) +
  scale_color_manual(
    values = c(
      "CD127+ Tex_SKIM lo" = "#7D2B54",
      "CD127+ Tex_SKIM hi" = "#7D2B55"
    )
  ) +
  scale_linetype_manual(values = c(
    "SKIM lo" = "dotted",
    "SKIM hi" = "solid"
  )) +
  scale_y_continuous(n.breaks = 3) +
  labs(y = "Frequency of CD127+\nTex (% CD8)",
      x = "Time (months)",
      color = "CD8 Tex\nsubset",
      linetype = "Baseline\nSKIM frequency") +
  theme(
    axis.title.y = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10)
  )
supp_fig_6G
ggsave("./figures/supp_fig_6G.pdf", supp_fig_6G, width = 4, height = 2)

```

# Assess autoreactive frequency in SKIM (supplementary figure 5B)

```{r}

specificity_df <- read_xlsx("./raw_data/SKIM_by_specificity.xlsx") %>%
  select(-`Virus-reactive`) %>%
  rename(`CD8 T cells` = CD8_t_cells)
df_long <- specificity_df %>%
  pivot_longer(cols = c(`CD8 T cells`, Autoreactive),
               names_to = "Type",
               values_to = "Value") %>%
  mutate(Type = factor(Type, levels = c("CD8 T cells", "Autoreactive")))
supp_fig_5B <- ggplot(df_long, aes(x = Type, y = Value)) +
  geom_boxplot(outlier.shape = NA) +   # boxplot without overplotting outliers
  geom_jitter(width = 0.2, size = 1) +  # add individual points
  labs(y = "SKIM frequency\n(% non-naive CD8)", x = "") +
  theme_classic() +
  theme(legend.position = "none")
supp_fig_5B
ggsave("./figures/supp_fig_5B.pdf", supp_fig_5B, width = 4, height = 3)

```

# Plot baseline SKIM frequency vs. age (supplementary figure 4A)

```{r}

skim_by_age <- read_xlsx("./raw_data/skim_by_age.xlsx") %>%
  mutate(age_group = if_else(Age < 30, "<30", ">=30"))
supp_fig_4A <- skim_by_age %>%
  ggplot(aes(
    x = Age,
    y = `TIGIT-KLRG1+CD127+_baseline`,
    color = Dataset
  )) +
  geom_point(size = 2) +
  geom_smooth(
    aes(group = age_group),
    method = "lm",
    se = FALSE,
    color = "black",
    linewidth = 1
  ) +
  labs(y = "Baseline SKIM\nfrequency (% CD8)")
supp_fig_4A
ggsave("./figures/supp_fig_4A.pdf", width = 5, height = 3)
# stats
# <30
model_lt30 <- lm(`TIGIT-KLRG1+CD127+_baseline` ~ Age,
                 data = subset(skim_by_age, age_group == "<30"))
summary(model_lt30)
# >=30
model_ge30 <- lm(`TIGIT-KLRG1+CD127+_baseline` ~ Age,
                 data = subset(skim_by_age, age_group == ">=30"))
summary(model_ge30)

```

# Stratify participants by age to compare T1D-free intervals (supplementary figure 4C)

```{r}

age_df <- tex_subsets <- read_xlsx("../raw_data/tex_subsets.xlsx") %>%
  mutate(Barcode = str_extract(`Sample:`, "^TN\\d+F\\d+")) %>%
  left_join(metadata, by = "Barcode") %>% 
  group_by(`Masked ID of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  select(`Sample:`, `Barcode`, `Masked ID of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`, `Age of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`, `Treatment Arm of Xtrial TN10 treatment info`, `Time.to.T1D (months)`, `T1D.event`, `Age of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file`) %>%
  mutate(
    strata = case_when(
      `Treatment Arm of Xtrial TN10 treatment info` == "Placebo" ~ "Placebo",
      `Age of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file` <= 15 ~ "under 15",
      `Age of TN10 Clinical Data_Linsley_20190104_copy 20240716 JMP file` < 35 ~ "15 to 35",
      TRUE ~ "over 35"
    )
  )
surv_obj <- survfit(Surv(`Time.to.T1D (months)`, T1D.event) ~ strata, data = age_df)
supp_fig_4C <- ggsurvplot(
  fit = survfit(Surv(`Time.to.T1D (months)`, T1D.event) ~ strata, data = age_df),
  data = age_df,
  palette = c("red", "blue", "grey", "purple"), 
  linetype = c("solid", "solid", "solid", "solid"),
  risk.table = TRUE,
  xlab = "Months",
  ylab = "% T1D Free",
  ylim = c(0, 100),
  fun = function(x) x * 100,
  break.time.by = 12,
  risk.table.height = 0.45,
  surv.plot.height  = 0.55,
  risk.table.fontsize = 5,
  tables.theme = theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 24)) +
    theme(
      axis.text = element_text(size = 20),
      axis.title = element_text(size = 24))
)
supp_fig_4C
pdf("./figures/supp_fig_4C.pdf", width = 3, height = 5)
print(supp_fig_4C)
dev.off()
age_df_stats <- age_df %>%
  rename(time_to_t1d = `Time.to.T1D (months)`)
# stats
p_young <- {
  df <- age_df_stats %>% filter(strata %in% c("Placebo", "under 15"))
  surv_diff <- survdiff(Surv(time_to_t1d, T1D.event) ~ strata, data = df)
  pchisq(surv_diff$chisq, df = length(surv_diff$n) - 1, lower.tail = FALSE)
}
p_middle <- {
  df <- age_df_stats %>% filter(strata %in% c("Placebo", "15 to 35"))
  surv_diff <- survdiff(Surv(time_to_t1d, T1D.event) ~ strata, data = df)
  pchisq(surv_diff$chisq, df = length(surv_diff$n) - 1, lower.tail = FALSE)
}
p_old <- {
  df <- age_df_stats %>% filter(strata %in% c("Placebo", "over 35"))
  surv_diff <- survdiff(Surv(time_to_t1d, T1D.event) ~ strata, data = df)
  pchisq(surv_diff$chisq, df = length(surv_diff$n) - 1, lower.tail = FALSE)
}
pvals <- tibble(
  comparison = c("Placebo vs under 15", "Placebo vs 15 to 35", "Placebo vs over 35"),
  logrank_p = c(p_young, p_middle, p_old)
)
pvals

```